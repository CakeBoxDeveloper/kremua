<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <title>Генератор билетов</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <style>
    body {
      margin: 0;
      font-family: Arial, sans-serif;
      background: #17212b;
      color: white;
      padding: 20px;
      min-height: 100vh;
    }
    .admin-container {
      max-width: 900px;
      margin: 0 auto;
    }
    .control-panel {
      background: #1d2b3a;
      border: 1px solid #6ab2f2;
      border-radius: 8px;
      padding: 20px;
      margin-bottom: 20px;
    }
    .btn {
      padding: 14px 24px;
      border-radius: 6px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s ease;
      font-size: 15px;
      border: none;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      width: 100%;
    }
    .btn:active {
      transform: scale(0.96);
    }
    .btn-primary {
      background: #1d3a22;
      border: 1px solid #6af27d;
      color: #6af27d;
    }
    .btn-danger {
      background: #3a1d2b;
      border: 1px solid #f27db0;
      color: #f27db0;
    }
    .btn-secondary {
      background: #1d2b3a;
      border: 1px solid #6ab2f2;
      color: #6ab2f2;
    }
    .btn-color {
      padding: 12px;
      font-size: 14px;
      font-weight: 600;
      transition: all 0.2s ease;
    }
    .btn-color.selected {
      background: var(--btn-border-color) !important;
      color: #17212b !important;
    }
    .ticket-output {
      background: transparent;
      border: none;
      border-radius: 4px;
      padding: 15px;
      margin: 15px 0;
      word-wrap: break-word;
      font-family: monospace;
      font-size: 14px;
      line-height: 1.6;
    }
    .ticket-link {
      text-decoration: none;
      display: block;
      margin: 5px 0 15px 0;
      word-break: break-all;
      font-weight: 600;
    }
    .qr-code-container {
      text-align: center;
      margin: 20px 0;
    }
    .qr-code-container canvas {
      border: 2px solid #6ab2f2;
      border-radius: 8px;
      padding: 10px;
      background: white;
    }
    .dashboard {
      background: transparent;
      border: none;
      border-radius: 8px;
      padding: 0;
    }
    .tickets-table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 0;
      border: 2px solid #6ab2f2;
      border-radius: 8px;
      overflow: hidden;
    }
    .tickets-table th {
      background: #6ab2f2;
      color: #17212b;
      padding: 12px;
      text-align: left;
      font-size: 14px;
      font-weight: 700;
    }
    .tickets-table th:first-child {
      border-top-left-radius: 8px;
    }
    .tickets-table th:last-child {
      border-top-right-radius: 8px;
    }
    .tickets-table td {
      padding: 12px;
      border-bottom: 1px solid rgba(106, 178, 242, 0.2);
      font-size: 14px;
    }
    .tickets-table tbody tr:last-child td {
      border-bottom: none;
    }
    .ticket-code {
      font-family: monospace;
      font-weight: 600;
    }
    .ticket-code.used {
      text-decoration: line-through;
      opacity: 0.5;
    }
    .empty-state {
      text-align: center;
      padding: 40px;
      opacity: 0.5;
    }
    .action-icons {
      display: flex;
      gap: 12px;
      align-items: center;
    }
    .icon-btn {
      cursor: pointer;
      opacity: 0.7;
      transition: opacity 0.2s;
      width: 20px;
      height: 20px;
      display: inline-block;
    }
    .icon-btn:hover {
      opacity: 1;
    }
    .btn-full {
      width: 100%;
      margin-top: 10px;
    }
    .button-row {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 15px;
      margin-top: 15px;
    }
  </style>
</head>
<body>
  <div class="admin-container">
    <!-- Панель управления -->
    <div class="control-panel">
      <div style="margin-bottom: 15px;">
        <div style="display: grid; grid-template-columns: repeat(5, 1fr); gap: 10px;">
          <button class="btn btn-color" onclick="selectColor('random')" id="color-random" style="background: #2b2b2b; border: 2px solid #9d9d9d; color: #9d9d9d; --btn-border-color: #9d9d9d;">
            Обычный
          </button>
          <button class="btn btn-color" onclick="selectColor('yellow')" id="color-yellow" style="background: #3a351d; border: 2px solid #f2d16a; color: #f2d16a; --btn-border-color: #f2d16a;">
            Жёлтый
          </button>
          <button class="btn btn-color" onclick="selectColor('red')" id="color-red" style="background: #3a1d1d; border: 2px solid #f25c5c; color: #f25c5c; --btn-border-color: #f25c5c;">
            Красный
          </button>
          <button class="btn btn-color" onclick="selectColor('blue')" id="color-blue" style="background: #1d2b3a; border: 2px solid #6ab2f2; color: #6ab2f2; --btn-border-color: #6ab2f2;">
            Синий
          </button>
          <button class="btn btn-color" onclick="selectColor('green')" id="color-green" style="background: #1d3a22; border: 2px solid #6af27d; color: #6af27d; --btn-border-color: #6af27d;">
            Зелёный
          </button>
        </div>
      </div>
      
      <div class="button-row">
        <button class="btn btn-primary" onclick="generateTicket()">
          Сгенерировать билет
        </button>
        <button class="btn btn-danger" onclick="clearAll()">
          Удалить все билеты
        </button>
      </div>
      
      <div id="output"></div>
    </div>
    
    <!-- Дашборд билетов -->
    <div class="dashboard">
      <div id="ticketsDashboard">
        <div class="empty-state">
          Нет сгенерированных билетов
        </div>
      </div>
    </div>
  </div>

  <!-- QRCode.js библиотека -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>

  <script>
// ⚠️ СЕКРЕТНЫЙ КЛЮЧ - ХРАНИ В СЕКРЕТЕ! СМЕНИ НА СВОЙ!
const SECRET_KEY = "your-super-secret-key-change-this-12345";

let lastTicket = '';
let selectedColor = 'random';

// Маппинг цветов
const colorHex = {
  'random': '#9d9d9d',
  'yellow': '#f2d16a',
  'red': '#f25c5c',
  'blue': '#6ab2f2',
  'green': '#6af27d'
};

// Функция выбора цвета
function selectColor(color) {
  selectedColor = color;
  
  document.querySelectorAll('.btn-color').forEach(btn => {
    btn.classList.remove('selected');
  });
  
  document.getElementById('color-' + color).classList.add('selected');
}

// Функция генерации HMAC-SHA256
async function generateHMAC(secret, message) {
  const encoder = new TextEncoder();
  const keyData = encoder.encode(secret);
  const messageData = encoder.encode(message);
  
  const cryptoKey = await crypto.subtle.importKey(
    'raw',
    keyData,
    { name: 'HMAC', hash: 'SHA-256' },
    false,
    ['sign']
  );
  
  const signature = await crypto.subtle.sign('HMAC', cryptoKey, messageData);
  
  return Array.from(new Uint8Array(signature))
    .map(b => b.toString(16).padStart(2, '0'))
    .join('')
    .substring(0, 16);
}

function generateTicketCode() {
  const chars = 'ABCDEFGHJKLMNPQRSTUVWXYZ23456789';
  let code = '';
  for (let i = 0; i < 8; i++) {
    code += chars[Math.floor(Math.random() * chars.length)];
  }
  return code;
}

// Функция кодирования цвета
function encodeColor(color) {
  const colorMap = {
    'random': '0',
    'red': '1',
    'blue': '2',
    'green': '3',
    'yellow': '4'
  };
  return colorMap[color] || '0';
}

async function generateTicket() {
  const timestamp = Date.now();
  const randomData = generateTicketCode();
  const colorCode = encodeColor(selectedColor);
  
  const ticketData = `${timestamp}-${randomData}-${colorCode}`;
  
  const signature = await generateHMAC(SECRET_KEY, ticketData);
  const ticketCode = `${ticketData}-${signature}`;
  const created = new Date().toISOString();
  
  const generatedTickets = JSON.parse(localStorage.getItem('generated_tickets') || '[]');
  generatedTickets.push({
    code: ticketCode,
    created: created,
    shortCode: randomData,
    color: selectedColor
  });
  localStorage.setItem('generated_tickets', JSON.stringify(generatedTickets));
  
  const currentUrl = window.location.href;
  const baseUrl = currentUrl.substring(0, currentUrl.lastIndexOf('/') + 1);
  const ticketUrl = `${baseUrl}roll.html?ticket=${encodeURIComponent(ticketCode)}`;
  
  lastTicket = ticketUrl;
  
  const linkColor = colorHex[selectedColor];
  
  const output = document.getElementById('output');
  output.innerHTML = `
    <div class="ticket-output">
      <a href="${ticketUrl}" target="_blank" class="ticket-link" style="color: ${linkColor};">${ticketUrl}</a>
      <div class="qr-code-container" id="qrcode"></div>
      <button class="btn btn-secondary btn-full" onclick="copyToClipboard('${ticketUrl}')">
        Скопировать ссылку
      </button>
    </div>
  `;
  
  // Генерация QR-кода
  new QRCode(document.getElementById("qrcode"), {
    text: ticketUrl,
    width: 200,
    height: 200,
    colorDark: "#17212b",
    colorLight: "#ffffff",
    correctLevel: QRCode.CorrectLevel.H
  });
  
  refreshDashboard();
}

function copyToClipboard(text) {
  navigator.clipboard.writeText(text).then(() => {
    alert('✅ Ссылка скопирована!');
  });
}

function deleteTicket(ticketCode) {
  if (confirm('Вы уверены, что хотите удалить этот билет?')) {
    const generatedTickets = JSON.parse(localStorage.getItem('generated_tickets') || '[]');
    const filtered = generatedTickets.filter(t => t.code !== ticketCode);
    localStorage.setItem('generated_tickets', JSON.stringify(filtered));
    
    const usedTickets = JSON.parse(localStorage.getItem('used_tickets') || '[]');
    const filteredUsed = usedTickets.filter(code => code !== ticketCode);
    localStorage.setItem('used_tickets', JSON.stringify(filteredUsed));
    
    refreshDashboard();
    alert('✅ Билет удален!');
  }
}

// SVG иконки
const svgIcons = {
  copy: '<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path></svg>',
  open: '<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M18 13v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h6"></path><polyline points="15 3 21 3 21 9"></polyline><line x1="10" y1="14" x2="21" y2="3"></line></svg>',
  delete: '<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path><line x1="10" y1="11" x2="10" y2="17"></line><line x1="14" y1="11" x2="14" y2="17"></line></svg>'
};

function refreshDashboard() {
  const generatedTickets = JSON.parse(localStorage.getItem('generated_tickets') || '[]');
  const usedTickets = JSON.parse(localStorage.getItem('used_tickets') || '[]');
  
  const dashboard = document.getElementById('ticketsDashboard');
  
  if (generatedTickets.length === 0) {
    dashboard.innerHTML = '<div class="empty-state">Нет сгенерированных билетов</div>';
    return;
  }
  
  const currentUrl = window.location.href;
  const baseUrl = currentUrl.substring(0, currentUrl.lastIndexOf('/') + 1);
  
  let tableHTML = `
    <table class="tickets-table">
      <thead>
        <tr>
          <th>Код</th>
          <th>Действия</th>
        </tr>
      </thead>
      <tbody>
  `;
  
  const sortedTickets = [...generatedTickets].sort((a, b) => {
    const aUsed = usedTickets.includes(a.code);
    const bUsed = usedTickets.includes(b.code);
    if (aUsed === bUsed) return new Date(b.created) - new Date(a.created);
    return aUsed ? 1 : -1;
  });
  
  sortedTickets.forEach(ticket => {
    const isUsed = usedTickets.includes(ticket.code);
    const ticketColor = ticket.color || 'random';
    const codeColor = colorHex[ticketColor];
    const ticketUrl = `${baseUrl}roll.html?ticket=${encodeURIComponent(ticket.code)}`;
    
    tableHTML += `
      <tr>
        <td><span class="ticket-code ${isUsed ? 'used' : ''}" style="color: ${codeColor};">${ticket.shortCode || ticket.code.substring(0, 8)}</span></td>
        <td>
          <div class="action-icons">
            ${!isUsed ? `
              <span class="icon-btn" onclick="copyToClipboard('${ticketUrl}')" title="Скопировать ссылку" style="color: #6ab2f2;">
                ${svgIcons.copy}
              </span>
              <a href="${ticketUrl}" target="_blank" title="Открыть ссылку" style="color: #6ab2f2;">
                <span class="icon-btn">
                  ${svgIcons.open}
                </span>
              </a>
            ` : ''}
            <span class="icon-btn" onclick="deleteTicket('${ticket.code}')" title="Удалить билет" style="color: #f27db0;">
              ${svgIcons.delete}
            </span>
          </div>
        </td>
      </tr>
    `;
  });
  
  tableHTML += '</tbody></table>';
  dashboard.innerHTML = tableHTML;
}

function clearAll() {
  if (confirm('⚠️ Удалить ВСЕ билеты и данные? Это необратимое действие!')) {
    localStorage.removeItem('generated_tickets');
    localStorage.removeItem('used_tickets');
    localStorage.removeItem('lottery_last_spin');
    document.getElementById('output').innerHTML = '';
    refreshDashboard();
    alert('✅ Все данные очищены!');
  }
}

refreshDashboard();
selectColor('random');
setInterval(refreshDashboard, 5000);
</script>
</body>
</html>
