<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <title>–ì–µ–Ω–µ—Ä–∞—Ç–æ—Ä –±–∏–ª–µ—Ç–æ–≤</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="icon" href="https://github.com/cakeboxdeveloper/kremua/raw/refs/heads/main/AFav.ico" type="image/x-icon">
  <style>
    body {
      margin: 0;
      font-family: Arial, sans-serif;
      background: #17212b;
      color: white;
      padding: 20px;
      min-height: 100vh;
    }
    .admin-container {
      max-width: 900px;
      margin: 0 auto;
    }
    .control-panel {
      background: #1d2b3a;
      border: 1px solid #6ab2f2;
      border-radius: 8px;
      padding: 20px;
      margin-bottom: 20px;
    }
    .btn {
      padding: 14px 24px;
      border-radius: 6px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s ease;
      font-size: 15px;
      border: none;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      width: 100%;
    }
    .btn:active {
      transform: scale(0.96);
    }
    .btn-primary {
      background: #1d3a22;
      border: 1px solid #6af27d;
      color: #6af27d;
    }
    .btn-danger {
      background: #3a1d2b;
      border: 1px solid #f27db0;
      color: #f27db0;
    }
    .btn-secondary {
      background: #1d2b3a;
      border: 1px solid #6ab2f2;
      color: #6ab2f2;
    }
    .btn-color {
      padding: 12px;
      font-size: 14px;
      font-weight: 600;
      transition: all 0.2s ease;
    }
    .btn-color.selected {
      background: var(--btn-border-color) !important;
      color: #17212b !important;
    }
    .ticket-output {
      background: transparent;
      border: none;
      border-radius: 4px;
      padding: 15px;
      margin: 15px 0;
      word-wrap: break-word;
      font-family: monospace;
      font-size: 14px;
      line-height: 1.6;
      text-align: center;
    }
    .ticket-link {
      text-decoration: none;
      display: block;
      margin: 5px 0 15px 0;
      word-break: break-all;
      font-weight: 600;
    }
    .qr-code-container {
      text-align: center;
      margin: 20px auto;
      display: flex;
      justify-content: center;
      align-items: center;
    }
    .qr-code-container canvas,
    .qr-code-container img {
      border: 2px solid #6ab2f2;
      border-radius: 8px;
      padding: 10px;
      background: white;
      width: 200px !important;
      height: 200px !important;
      image-rendering: -webkit-optimize-contrast;
      image-rendering: crisp-edges;
    }
    .dashboard {
      background: transparent;
      border: none;
      border-radius: 8px;
      padding: 0;
    }
    .tickets-table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 0;
      border: 2px solid #6ab2f2;
      border-radius: 8px;
      overflow: hidden;
    }
    .tickets-table th {
      background: #6ab2f2;
      color: #17212b;
      padding: 12px;
      text-align: left;
      font-size: 14px;
      font-weight: 700;
    }
    .tickets-table th:first-child {
      border-top-left-radius: 8px;
    }
    .tickets-table th:last-child {
      border-top-right-radius: 8px;
    }
    .tickets-table td {
      padding: 12px;
      border-bottom: 1px solid rgba(106, 178, 242, 0.2);
      font-size: 14px;
    }
    .tickets-table tbody tr:last-child td {
      border-bottom: none;
    }
    .ticket-code {
      font-family: monospace;
      font-weight: 600;
    }
    .ticket-code.used {
      text-decoration: line-through;
      opacity: 0.5;
    }
    .empty-state {
      text-align: center;
      padding: 40px;
      opacity: 0.5;
    }
    .action-icons {
      display: flex;
      gap: 12px;
      align-items: center;
    }
    .icon-btn {
      cursor: pointer;
      opacity: 0.7;
      transition: opacity 0.2s;
      width: 20px;
      height: 20px;
      display: inline-block;
    }
    .icon-btn:hover {
      opacity: 1;
    }
    .btn-full {
      width: 100%;
      margin-top: 10px;
    }
    .button-row {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 15px;
      margin-top: 15px;
    }
  </style>
</head>
<body>
  <div class="admin-container">
    <!-- –ü–∞–Ω–µ–ª—å —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è -->
    <div class="control-panel">
      <div style="margin-bottom: 15px;">
        <div style="display: grid; grid-template-columns: repeat(5, 1fr); gap: 10px;">
          <button class="btn btn-color" onclick="selectColor('random')" id="color-random" style="background: #2b2b2b; border: 2px solid #9d9d9d; color: #9d9d9d; --btn-border-color: #9d9d9d;">
            –û–±—ã—á–Ω—ã–π
          </button>
          <button class="btn btn-color" onclick="selectColor('yellow')" id="color-yellow" style="background: #3a351d; border: 2px solid #f2d16a; color: #f2d16a; --btn-border-color: #f2d16a;">
            –ñ—ë–ª—Ç—ã–π
          </button>
          <button class="btn btn-color" onclick="selectColor('red')" id="color-red" style="background: #3a1d1d; border: 2px solid #f25c5c; color: #f25c5c; --btn-border-color: #f25c5c;">
            –ö—Ä–∞—Å–Ω—ã–π
          </button>
          <button class="btn btn-color" onclick="selectColor('blue')" id="color-blue" style="background: #1d2b3a; border: 2px solid #6ab2f2; color: #6ab2f2; --btn-border-color: #6ab2f2;">
            –°–∏–Ω–∏–π
          </button>
          <button class="btn btn-color" onclick="selectColor('green')" id="color-green" style="background: #1d3a22; border: 2px solid #6af27d; color: #6af27d; --btn-border-color: #6af27d;">
            –ó–µ–ª—ë–Ω—ã–π
          </button>
        </div>
      </div>
      
      <div class="button-row">
        <button class="btn btn-primary" onclick="generateTicket()">
          –°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å –±–∏–ª–µ—Ç
        </button>
        <button class="btn btn-danger" onclick="clearAll()">
          –£–¥–∞–ª–∏—Ç—å –≤—Å–µ –±–∏–ª–µ—Ç—ã
        </button>
      </div>
      
      <div id="output"></div>
    </div>
    
    <!-- –î–∞—à–±–æ—Ä–¥ –±–∏–ª–µ—Ç–æ–≤ -->
    <div class="dashboard">
      <div id="ticketsDashboard">
        <div class="empty-state">
          –ù–µ—Ç —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö –±–∏–ª–µ—Ç–æ–≤
        </div>
      </div>
    </div>
  </div>

  <!-- QRCode.js –±–∏–±–ª–∏–æ—Ç–µ–∫–∞ -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>

  <script>
// ‚ö†Ô∏è –°–ï–ö–†–ï–¢–ù–´–ô –ö–õ–Æ–ß - –•–†–ê–ù–ò –í –°–ï–ö–†–ï–¢–ï! –°–ú–ï–ù–ò –ù–ê –°–í–û–ô!
const SECRET_KEY = "your-super-secret-key-change-this-12345";

let lastTicket = '';
let selectedColor = 'random';

// –ú–∞–ø–ø–∏–Ω–≥ —Ü–≤–µ—Ç–æ–≤
const colorHex = {
  'random': '#9d9d9d',
  'yellow': '#f2d16a',
  'red': '#f25c5c',
  'blue': '#6ab2f2',
  'green': '#6af27d'
};

// –§—É–Ω–∫—Ü–∏—è –≤—ã–±–æ—Ä–∞ —Ü–≤–µ—Ç–∞
function selectColor(color) {
  selectedColor = color;
  
  document.querySelectorAll('.btn-color').forEach(btn => {
    btn.classList.remove('selected');
  });
  
  document.getElementById('color-' + color).classList.add('selected');
}

// –§—É–Ω–∫—Ü–∏—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ HMAC-SHA256
async function generateHMAC(secret, message) {
  const encoder = new TextEncoder();
  const keyData = encoder.encode(secret);
  const messageData = encoder.encode(message);
  
  const cryptoKey = await crypto.subtle.importKey(
    'raw',
    keyData,
    { name: 'HMAC', hash: 'SHA-256' },
    false,
    ['sign']
  );
  
  const signature = await crypto.subtle.sign('HMAC', cryptoKey, messageData);
  
  return Array.from(new Uint8Array(signature))
    .map(b => b.toString(16).padStart(2, '0'))
    .join('')
    .substring(0, 16);
}

function generateTicketCode() {
  const chars = 'ABCDEFGHJKLMNPQRSTUVWXYZ23456789';
  let code = '';
  for (let i = 0; i < 8; i++) {
    code += chars[Math.floor(Math.random() * chars.length)];
  }
  return code;
}

// –§—É–Ω–∫—Ü–∏—è –∫–æ–¥–∏—Ä–æ–≤–∞–Ω–∏—è —Ü–≤–µ—Ç–∞
function encodeColor(color) {
  const colorMap = {
    'random': '0',
    'red': '1',
    'blue': '2',
    'green': '3',
    'yellow': '4'
  };
  return colorMap[color] || '0';
}

// –§—É–Ω–∫—Ü–∏—è —Å–æ–∫—Ä–∞—â–µ–Ω–∏—è URL —á–µ—Ä–µ–∑ TinyURL
async function shortenURL(longUrl) {
  try {
    const response = await fetch(`https://tinyurl.com/api-create.php?url=${encodeURIComponent(longUrl)}`);
    if (response.ok) {
      return await response.text();
    }
  } catch (error) {
    console.error('–û—à–∏–±–∫–∞ —Å–æ–∫—Ä–∞—â–µ–Ω–∏—è URL:', error);
  }
  return longUrl; // –í–æ–∑–≤—Ä–∞—â–∞–µ–º –æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω—ã–π URL –µ—Å–ª–∏ –Ω–µ —É–¥–∞–ª–æ—Å—å —Å–æ–∫—Ä–∞—Ç–∏—Ç—å
}

async function generateTicket() {
  const timestamp = Date.now();
  const randomData = generateTicketCode();
  const colorCode = encodeColor(selectedColor);
  
  const ticketData = `${timestamp}-${randomData}-${colorCode}`;
  
  const signature = await generateHMAC(SECRET_KEY, ticketData);
  const ticketCode = `${ticketData}-${signature}`;
  const created = new Date().toISOString();
  
  const currentUrl = window.location.href;
  const baseUrl = currentUrl.substring(0, currentUrl.lastIndexOf('/') + 1);
  const ticketUrl = `${baseUrl}roll.html?ticket=${encodeURIComponent(ticketCode)}`;
  
  // –°–æ–∫—Ä–∞—â–∞–µ–º URL
  const shortUrl = await shortenURL(ticketUrl);
  
  const generatedTickets = JSON.parse(localStorage.getItem('generated_tickets') || '[]');
  generatedTickets.push({
    code: ticketCode,
    created: created,
    shortCode: randomData,
    color: selectedColor,
    url: ticketUrl,
    shortUrl: shortUrl
  });
  localStorage.setItem('generated_tickets', JSON.stringify(generatedTickets));
  
  lastTicket = shortUrl;
  
  const linkColor = colorHex[selectedColor];
  
  const output = document.getElementById('output');
  output.innerHTML = `
    <div class="ticket-output">
      <a href="${ticketUrl}" target="_blank" class="ticket-link" style="color: ${linkColor};">${shortUrl}</a>
      <div class="qr-code-container" id="qrcode"></div>
      <button class="btn btn-secondary btn-full" onclick="copyToClipboard('${shortUrl}')">
        –°–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å —Å—Å—ã–ª–∫—É
      </button>
    </div>
  `;
  
  // –°–æ–∑–¥–∞–µ–º –≤—Ä–µ–º–µ–Ω–Ω—ã–π –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä –¥–ª—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ QR –≤ –≤—ã—Å–æ–∫–æ–º —Ä–∞–∑—Ä–µ—à–µ–Ω–∏–∏
  const tempDiv = document.createElement('div');
  tempDiv.style.position = 'absolute';
  tempDiv.style.left = '-9999px';
  document.body.appendChild(tempDiv);
  
  // –ì–µ–Ω–µ—Ä–∞—Ü–∏—è QR-–∫–æ–¥–∞ –≤ –≤—ã—Å–æ–∫–æ–º —Ä–∞–∑—Ä–µ—à–µ–Ω–∏–∏ (1160x1160)
  const qr = new QRCode(tempDiv, {
  text: shortUrl,
  width: 1160,
  height: 1160,
  colorDark: "#000000",    // üëà –ß–Å–†–ù–´–ô –≤–º–µ—Å—Ç–æ #17212b
  colorLight: "#ffffff",   // üëà –ë–ï–õ–´–ô (—É–∂–µ –ø—Ä–∞–≤–∏–ª—å–Ω–æ)
  correctLevel: QRCode.CorrectLevel.M
});
  
  // –ñ–¥—ë–º –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –∏ –∫–æ–ø–∏—Ä—É–µ–º –≤ –æ—Å–Ω–æ–≤–Ω–æ–π –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä
  setTimeout(() => {
    const canvas = tempDiv.querySelector('canvas');
    if (canvas) {
      const img = document.createElement('img');
      img.src = canvas.toDataURL('image/png');
      img.style.width = '200px';
      img.style.height = '200px';
      
      const container = document.getElementById('qrcode');
      container.innerHTML = '';
      container.appendChild(img);
      
      // –î–æ–±–∞–≤–ª—è–µ–º –∫–Ω–æ–ø–∫—É —Å–∫–∞—á–∏–≤–∞–Ω–∏—è QR-–∫–æ–¥–∞
      const downloadBtn = document.createElement('button');
      downloadBtn.className = 'btn btn-secondary btn-full';
      downloadBtn.textContent = '–°–∫–∞—á–∞—Ç—å QR-–∫–æ–¥ (1160x1160)';
      downloadBtn.onclick = () => {
        const link = document.createElement('a');
        link.download = `qr-${randomData}.png`;
        link.href = canvas.toDataURL('image/png');
        link.click();
      };
      output.querySelector('.ticket-output').appendChild(downloadBtn);
    }
    
    // –£–¥–∞–ª—è–µ–º –≤—Ä–µ–º–µ–Ω–Ω—ã–π –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä
    document.body.removeChild(tempDiv);
  }, 100);
  
  refreshDashboard();
}

function copyToClipboard(text) {
  navigator.clipboard.writeText(text).then(() => {
    alert('‚úÖ –°—Å—ã–ª–∫–∞ —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∞!');
  });
}

function deleteTicket(ticketCode) {
  if (confirm('–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å —ç—Ç–æ—Ç –±–∏–ª–µ—Ç?')) {
    const generatedTickets = JSON.parse(localStorage.getItem('generated_tickets') || '[]');
    const filtered = generatedTickets.filter(t => t.code !== ticketCode);
    localStorage.setItem('generated_tickets', JSON.stringify(filtered));
    
    const usedTickets = JSON.parse(localStorage.getItem('used_tickets') || '[]');
    const filteredUsed = usedTickets.filter(code => code !== ticketCode);
    localStorage.setItem('used_tickets', JSON.stringify(filteredUsed));
    
    refreshDashboard();
    alert('‚úÖ –ë–∏–ª–µ—Ç —É–¥–∞–ª–µ–Ω!');
  }
}

// SVG –∏–∫–æ–Ω–∫–∏
const svgIcons = {
  copy: '<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path></svg>',
  open: '<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M18 13v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h6"></path><polyline points="15 3 21 3 21 9"></polyline><line x1="10" y1="14" x2="21" y2="3"></line></svg>',
  delete: '<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path><line x1="10" y1="11" x2="10" y2="17"></line><line x1="14" y1="11" x2="14" y2="17"></line></svg>'
};

function refreshDashboard() {
  const generatedTickets = JSON.parse(localStorage.getItem('generated_tickets') || '[]');
  const usedTickets = JSON.parse(localStorage.getItem('used_tickets') || '[]');
  
  const dashboard = document.getElementById('ticketsDashboard');
  
  if (generatedTickets.length === 0) {
    dashboard.innerHTML = '<div class="empty-state">–ù–µ—Ç —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö –±–∏–ª–µ—Ç–æ–≤</div>';
    return;
  }
  
  let tableHTML = `
    <table class="tickets-table">
      <thead>
        <tr>
          <th>–ö–æ–¥</th>
          <th>–î–µ–π—Å—Ç–≤–∏—è</th>
        </tr>
      </thead>
      <tbody>
  `;
  
  // –°–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞: –Ω–æ–≤—ã–µ —Å–≤–µ—Ä—Ö—É (–ø–æ –¥–∞—Ç–µ —Å–æ–∑–¥–∞–Ω–∏—è), –±–µ–∑ –ø–µ—Ä–µ—Å—Ç–∞–Ω–æ–≤–∫–∏ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–Ω—ã—Ö
  const sortedTickets = [...generatedTickets].sort((a, b) => {
    return new Date(b.created) - new Date(a.created);
  });
  
  sortedTickets.forEach(ticket => {
    const isUsed = usedTickets.includes(ticket.code);
    const ticketColor = ticket.color || 'random';
    const codeColor = colorHex[ticketColor];
    const ticketUrl = ticket.shortUrl || ticket.url || `${window.location.origin}/roll.html?ticket=${encodeURIComponent(ticket.code)}`;
    
    tableHTML += `
      <tr>
        <td><span class="ticket-code ${isUsed ? 'used' : ''}" style="color: ${codeColor};">${ticket.shortCode || ticket.code.substring(0, 8)}</span></td>
        <td>
          <div class="action-icons">
            ${!isUsed ? `
              <span class="icon-btn" onclick="copyToClipboard('${ticketUrl}')" title="–°–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å —Å—Å—ã–ª–∫—É" style="color: #6ab2f2;">
                ${svgIcons.copy}
              </span>
              <a href="${ticketUrl}" target="_blank" title="–û—Ç–∫—Ä—ã—Ç—å —Å—Å—ã–ª–∫—É" style="color: #6ab2f2;">
                <span class="icon-btn">
                  ${svgIcons.open}
                </span>
              </a>
            ` : ''}
            <span class="icon-btn" onclick="deleteTicket('${ticket.code}')" title="–£–¥–∞–ª–∏—Ç—å –±–∏–ª–µ—Ç" style="color: #f27db0;">
              ${svgIcons.delete}
            </span>
          </div>
        </td>
      </tr>
    `;
  });
  
  tableHTML += '</tbody></table>';
  dashboard.innerHTML = tableHTML;
}

function clearAll() {
  if (confirm('‚ö†Ô∏è –£–¥–∞–ª–∏—Ç—å –í–°–ï –±–∏–ª–µ—Ç—ã –∏ –¥–∞–Ω–Ω—ã–µ? –≠—Ç–æ –Ω–µ–æ–±—Ä–∞—Ç–∏–º–æ–µ –¥–µ–π—Å—Ç–≤–∏–µ!')) {
    localStorage.removeItem('generated_tickets');
    localStorage.removeItem('used_tickets');
    localStorage.removeItem('lottery_last_spin');
    document.getElementById('output').innerHTML = '';
    refreshDashboard();
    alert('‚úÖ –í—Å–µ –¥–∞–Ω–Ω—ã–µ –æ—á–∏—â–µ–Ω—ã!');
  }
}

refreshDashboard();
selectColor('random');
setInterval(refreshDashboard, 5000);
</script>
</body>
</html>
