<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <title>Admin - –ì–µ–Ω–µ—Ä–∞—Ü—ñ—è –±—ñ–ª–µ—Ç—ñ–≤</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <style>
    body {
      margin: 0;
      font-family: Arial, sans-serif;
      background: #17212b;
      color: white;
      padding: 20px;
      min-height: 100vh;
    }
    .admin-container {
      max-width: 900px;
      margin: 0 auto;
    }
    h1 {
      color: #6ab2f2;
      text-align: center;
      margin-bottom: 30px;
    }
    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 15px;
      margin-bottom: 30px;
    }
    .stat-card {
      background: #1d2b3a;
      border: 1px solid #6ab2f2;
      border-radius: 8px;
      padding: 20px;
      text-align: center;
    }
    .stat-number {
      font-size: 36px;
      font-weight: 700;
      color: #6ab2f2;
      margin: 10px 0;
    }
    .stat-label {
      font-size: 14px;
      opacity: 0.85;
    }
    .control-panel {
      background: #1d2b3a;
      border: 1px solid #6ab2f2;
      border-radius: 8px;
      padding: 20px;
      margin-bottom: 20px;
    }
    .btn {
      padding: 14px 24px;
      margin: 5px;
      border-radius: 6px;
      font-weight: 600;
      cursor: pointer;
      transition: transform 0.15s ease;
      font-size: 15px;
      border: none;
      display: inline-flex;
      align-items: center;
      gap: 8px;
    }
    .btn:active {
      transform: scale(0.96);
    }
    .btn-primary {
      background: #1d3a22;
      border: 1px solid #6af27d;
      color: #6af27d;
    }
    .btn-danger {
      background: #3a1d2b;
      border: 1px solid #f27db0;
      color: #f27db0;
    }
    .btn-secondary {
      background: #1d2b3a;
      border: 1px solid #6ab2f2;
      color: #6ab2f2;
    }
    .ticket-output {
      background: #0f1419;
      border: 1px solid #6af27d;
      border-radius: 4px;
      padding: 15px;
      margin: 15px 0;
      word-wrap: break-word;
      font-family: monospace;
      font-size: 14px;
      line-height: 1.6;
    }
    .ticket-link {
      color: #6af27d;
      text-decoration: none;
      display: block;
      margin: 5px 0;
      word-break: break-all;
    }
    .dashboard {
      background: #1d2b3a;
      border: 1px solid #6ab2f2;
      border-radius: 8px;
      padding: 20px;
    }
    .dashboard h2 {
      color: #6ab2f2;
      margin-top: 0;
    }
    .tickets-table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 15px;
    }
    .tickets-table th {
      background: #0f1419;
      padding: 12px;
      text-align: left;
      border-bottom: 2px solid #6ab2f2;
      font-size: 14px;
    }
    .tickets-table td {
      padding: 12px;
      border-bottom: 1px solid rgba(106, 178, 242, 0.2);
      font-size: 14px;
    }
    .status-badge {
      display: inline-block;
      padding: 4px 12px;
      border-radius: 4px;
      font-size: 12px;
      font-weight: 600;
    }
    .status-active {
      background: #1d3a22;
      color: #6af27d;
      border: 1px solid #6af27d;
    }
    .status-used {
      background: #3a1d2b;
      color: #f27db0;
      border: 1px solid #f27db0;
    }
    .ticket-code {
      font-family: monospace;
      font-weight: 600;
      color: #6ab2f2;
    }
    .empty-state {
      text-align: center;
      padding: 40px;
      opacity: 0.5;
    }
    .copy-icon {
      cursor: pointer;
      opacity: 0.7;
      transition: opacity 0.2s;
      font-size: 18px;
    }
    .copy-icon:hover {
      opacity: 1;
    }
  </style>
</head>
<body>
  <div class="admin-container">
    <h1>üé´ –ü–∞–Ω–µ–ª—å –∫–µ—Ä—É–≤–∞–Ω–Ω—è –±—ñ–ª–µ—Ç–∞–º–∏</h1>
    
    <!-- –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ -->
    <div class="stats-grid">
      <div class="stat-card">
        <div class="stat-label">–í—Å—å–æ–≥–æ –±—ñ–ª–µ—Ç—ñ–≤</div>
        <div class="stat-number" id="totalTickets">0</div>
      </div>
      <div class="stat-card">
        <div class="stat-label">‚úÖ –ê–∫—Ç–∏–≤–Ω—ñ</div>
        <div class="stat-number" style="color: #6af27d;" id="activeTickets">0</div>
      </div>
      <div class="stat-card">
        <div class="stat-label">‚ùå –í–∏–∫–æ—Ä–∏—Å—Ç–∞–Ω—ñ</div>
        <div class="stat-number" style="color: #f27db0;" id="usedTicketsCount">0</div>
      </div>
    </div>
    
    <!-- –ü–∞–Ω–µ–ª—å —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è -->
    <div class="control-panel">
      <button class="btn btn-primary" onclick="generateTicket()">
        ‚ûï –ó–≥–µ–Ω–µ—Ä—É–≤–∞—Ç–∏ –±—ñ–ª–µ—Ç
      </button>
      <button class="btn btn-secondary" onclick="refreshDashboard()">
        üîÑ –û–Ω–æ–≤–∏—Ç–∏
      </button>
      <button class="btn btn-danger" onclick="clearAll()">
        üóëÔ∏è –û—á–∏—Å—Ç–∏—Ç–∏ –≤—Å—ñ –¥–∞–Ω—ñ
      </button>
      
      <div id="output"></div>
    </div>
    
    <!-- –î–∞—à–±–æ—Ä–¥ –±–∏–ª–µ—Ç–æ–≤ -->
    <div class="dashboard">
      <h2>üìä –í—Å—ñ –±—ñ–ª–µ—Ç–∏</h2>
      <div id="ticketsDashboard">
        <div class="empty-state">
          –ù–µ–º–∞—î –∑–≥–µ–Ω–µ—Ä–æ–≤–∞–Ω–∏—Ö –±—ñ–ª–µ—Ç—ñ–≤
        </div>
      </div>
    </div>
  </div>

 <script>
// ‚ö†Ô∏è –°–ï–ö–†–ï–¢–ù–´–ô –ö–õ–Æ–ß - –•–†–ê–ù–ò –í –°–ï–ö–†–ï–¢–ï! –°–ú–ï–ù–ò –ù–ê –°–í–û–ô!
const SECRET_KEY = "your-super-secret-key-change-this-12345";

let lastTicket = '';

// –§—É–Ω–∫—Ü–∏—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ HMAC-SHA256
async function generateHMAC(secret, message) {
  const encoder = new TextEncoder();
  const keyData = encoder.encode(secret);
  const messageData = encoder.encode(message);
  
  const cryptoKey = await crypto.subtle.importKey(
    'raw',
    keyData,
    { name: 'HMAC', hash: 'SHA-256' },
    false,
    ['sign']
  );
  
  const signature = await crypto.subtle.sign('HMAC', cryptoKey, messageData);
  
  return Array.from(new Uint8Array(signature))
    .map(b => b.toString(16).padStart(2, '0'))
    .join('')
    .substring(0, 16); // –ü–µ—Ä–≤—ã–µ 16 —Å–∏–º–≤–æ–ª–æ–≤ –¥–ª—è –∫–æ–º–ø–∞–∫—Ç–Ω–æ—Å—Ç–∏
}

function generateTicketCode() {
  const chars = 'ABCDEFGHJKLMNPQRSTUVWXYZ23456789';
  let code = '';
  for (let i = 0; i < 8; i++) {
    code += chars[Math.floor(Math.random() * chars.length)];
  }
  return code;
}

async function generateTicket() {
  // –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º –¥–∞–Ω–Ω—ã–µ –±–∏–ª–µ—Ç–∞
  const timestamp = Date.now();
  const randomData = generateTicketCode();
  const ticketData = `${timestamp}-${randomData}`;
  
  // –°–æ–∑–¥–∞—ë–º –ø–æ–¥–ø–∏—Å—å
  const signature = await generateHMAC(SECRET_KEY, ticketData);
  
  // –§–∏–Ω–∞–ª—å–Ω—ã–π –∫–æ–¥: TIMESTAMP-RANDOM-SIGNATURE
  const ticketCode = `${ticketData}-${signature}`;
  const created = new Date().toISOString();
  
  // –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤ —Å–ø–∏—Å–æ–∫ —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö –±–∏–ª–µ—Ç–æ–≤ (–¥–ª—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏)
  const generatedTickets = JSON.parse(localStorage.getItem('generated_tickets') || '[]');
  generatedTickets.push({
    code: ticketCode,
    created: created,
    shortCode: randomData
  });
  localStorage.setItem('generated_tickets', JSON.stringify(generatedTickets));
  
  // ‚úÖ –ò–°–ü–†–ê–í–õ–ï–ù–ù–ê–Ø –ì–ï–ù–ï–†–ê–¶–ò–Ø URL
  const currentUrl = window.location.href;
  const baseUrl = currentUrl.substring(0, currentUrl.lastIndexOf('/') + 1);
  const ticketUrl = `${baseUrl}roll.html?ticket=${encodeURIComponent(ticketCode)}`;
  
  lastTicket = ticketUrl;
  
  // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç
  const output = document.getElementById('output');
  output.innerHTML = `
    <div class="ticket-output">
      <strong>üéâ –ù–æ–≤–∏–π –±—ñ–ª–µ—Ç –∑–≥–µ–Ω–µ—Ä–æ–≤–∞–Ω–æ!</strong><br><br>
      <strong>–ö–æ—Ä–æ—Ç–∫–∏–π –∫–æ–¥:</strong> ${randomData}<br>
      <strong>–ü–æ–≤–Ω–∏–π –∫–æ–¥:</strong> ${ticketCode.substring(0, 40)}...<br><br>
      <strong>–ü–æ—Å–∏–ª–∞–Ω–Ω—è:</strong><br>
      <a href="${ticketUrl}" target="_blank" class="ticket-link">${ticketUrl}</a><br>
      <button class="btn btn-secondary" onclick="copyToClipboard('${ticketUrl}')">
        üìã –°–∫–æ–ø—ñ—é–≤–∞—Ç–∏ –ø–æ—Å–∏–ª–∞–Ω–Ω—è
      </button>
    </div>
  `;
  
  refreshDashboard();
}

function copyToClipboard(text) {
  navigator.clipboard.writeText(text).then(() => {
    alert('‚úÖ –ü–æ—Å–∏–ª–∞–Ω–Ω—è —Å–∫–æ–ø—ñ–π–æ–≤–∞–Ω–æ!');
  });
}

function refreshDashboard() {
  const generatedTickets = JSON.parse(localStorage.getItem('generated_tickets') || '[]');
  const usedTickets = JSON.parse(localStorage.getItem('used_tickets') || '[]');
  
  // –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É
  const activeCount = generatedTickets.filter(t => !usedTickets.includes(t.code)).length;
  document.getElementById('totalTickets').textContent = generatedTickets.length;
  document.getElementById('activeTickets').textContent = activeCount;
  document.getElementById('usedTicketsCount').textContent = usedTickets.length;
  
  // –°–æ–∑–¥–∞–µ–º —Ç–∞–±–ª–∏—Ü—É –±–∏–ª–µ—Ç–æ–≤
  const dashboard = document.getElementById('ticketsDashboard');
  
  if (generatedTickets.length === 0) {
    dashboard.innerHTML = '<div class="empty-state">–ù–µ–º–∞—î –∑–≥–µ–Ω–µ—Ä–æ–≤–∞–Ω–∏—Ö –±—ñ–ª–µ—Ç—ñ–≤</div>';
    return;
  }
  
 const currentUrl = window.location.href;
  const baseUrl = currentUrl.substring(0, currentUrl.lastIndexOf('/') + 1);
  
  let tableHTML = `
    <table class="tickets-table">
      <thead>
        <tr>
          <th>–ö–æ–¥</th>
          <th>–°—Ç–∞—Ç—É—Å</th>
          <th>–°—Ç–≤–æ—Ä–µ–Ω–æ</th>
          <th>–î—ñ—ó</th>
        </tr>
      </thead>
      <tbody>
  `;
  
  // –°–æ—Ä—Ç–∏—Ä—É–µ–º: —Å–Ω–∞—á–∞–ª–∞ –∞–∫—Ç–∏–≤–Ω—ã–µ, –ø–æ—Ç–æ–º –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–Ω—ã–µ
  const sortedTickets = [...generatedTickets].sort((a, b) => {
    const aUsed = usedTickets.includes(a.code);
    const bUsed = usedTickets.includes(b.code);
    if (aUsed === bUsed) return new Date(b.created) - new Date(a.created);
    return aUsed ? 1 : -1;
  });
  
  sortedTickets.forEach(ticket => {
    const isUsed = usedTickets.includes(ticket.code);
    const ticketUrl = `${baseUrl}roll.html?ticket=${encodeURIComponent(ticket.code)}`;
    const date = new Date(ticket.created).toLocaleString('uk-UA', {
      day: '2-digit',
      month: '2-digit',
      year: 'numeric',
      hour: '2-digit',
      minute: '2-digit'
    });
    
    tableHTML += `
      <tr>
        <td><span class="ticket-code">${ticket.shortCode || ticket.code.substring(0, 8)}</span></td>
        <td>
          <span class="status-badge ${isUsed ? 'status-used' : 'status-active'}">
            ${isUsed ? '‚ùå –í–∏–∫–æ—Ä–∏—Å—Ç–∞–Ω–∏–π' : '‚úÖ –ê–∫—Ç–∏–≤–Ω–∏–π'}
          </span>
        </td>
        <td>${date}</td>
        <td>
          ${!isUsed ? `
            <span class="copy-icon" onclick="copyToClipboard('${ticketUrl}')" title="–°–∫–æ–ø—ñ—é–≤–∞—Ç–∏ –ø–æ—Å–∏–ª–∞–Ω–Ω—è">
              üìã
            </span>
          ` : '‚Äî'}
        </td>
      </tr>
    `;
  });
  
  tableHTML += '</tbody></table>';
  dashboard.innerHTML = tableHTML;
}

function clearAll() {
  if (confirm('‚ö†Ô∏è –í–∏–¥–∞–ª–∏—Ç–∏ –í–°–Ü –±—ñ–ª–µ—Ç–∏ —Ç–∞ –¥–∞–Ω—ñ? –¶–µ –Ω–µ–∑–≤–æ—Ä–æ—Ç–Ω–∞ –¥—ñ—è!')) {
    localStorage.removeItem('generated_tickets');
    localStorage.removeItem('used_tickets');
    localStorage.removeItem('lottery_last_spin');
    document.getElementById('output').innerHTML = '';
    refreshDashboard();
    alert('‚úÖ –í—Å—ñ –¥–∞–Ω—ñ –æ—á–∏—â–µ–Ω–æ!');
  }
}

// –û–±–Ω–æ–≤–ª—è–µ–º –¥–∞—à–±–æ—Ä–¥ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ
refreshDashboard();

// –ê–≤—Ç–æ–æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∫–∞–∂–¥—ã–µ 5 —Å–µ–∫—É–Ω–¥
setInterval(refreshDashboard, 5000);
</script>
</body>
</html>
